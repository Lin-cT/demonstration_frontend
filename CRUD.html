<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Demo</title>
</head>
<table>
    <thead>
    <tr>
      <th>Name</th>
      <th>ID</th>
      <th>Age</th>
      <th>Favorite Color</th>
      <th>Role</th>
    </tr>
    </thead>
    <tbody id="result">
      <!-- javascript generated data -->
    </tbody>
  </table>
  
  <a href="http://127.0.0.1:4200/demonstration_frontend//delete.html">
      <button class="delete-button">Delete (Admin Only)</button>
  </a>
  
  <a href="http://127.0.0.1:4200/demonstration_frontend//update.html">
      <button class="update-button">Update (Admin Only)</button>
  </a>
  
  <!-- 
  Below JavaScript code fetches user data from an API and displays it in a table. It uses the Fetch API to make a GET request to the '/api/users/' endpoint.   Refer to config.js to see additional options. 
  
  The script is laid out in a sequence (no function) and will execute when page is loaded.
  -->
  <script type="module">
    // Define the checkAdminRole function first
    function checkAdminRole() {
        // Get the JWT token from the cookie
        const jwtToken = document.cookie.split('; ').find(row => row.startsWith('jwt='));

        if (jwtToken) {
            try {
                // Decode the JWT token to extract the payload
                const tokenPayload = jwtToken.split('=')[1];
                const decodedToken = JSON.parse(atob(tokenPayload.split('.')[1]));

                // Extract the role from the payload
                const userRole = decodedToken.role;

                // Check if the user is an admin
                if (userRole === 'Admin') {
                    return true;
                }
            } catch (error) {
                console.error('Error decoding JWT token:', error);
            }
        }
        return false;
    }
    // uri variable and options object are obtained from config.js
    import { uri, options } from 'http://127.0.0.1:4200/demonstration_frontend/assets/js/api/config.js';
  
    // Set Users endpoint (list of users)
    const url = uri + '/api/users/';
  
    // prepare HTML result container for new output
    const resultContainer = document.getElementById("result");
  
    // fetch the API
    fetch(url, options)
      // response is a RESTful "promise" on any successful fetch
      .then(response => {
        // check for response errors and display
        if (response.status !== 200) {
            const errorMsg = 'Database response error: ' + response.status;
            console.log(errorMsg);
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.innerHTML = errorMsg;
            tr.appendChild(td);
            resultContainer.appendChild(tr);
            return;
        }
        // valid response will contain JSON data
        response.json().then(data => {
            console.log(data);
            // Check if the user has admin role
            const isAdmin = checkAdminRole(); // Assuming you have a function to check admin role
            if (!isAdmin) {
                const errorMsg = 'You do not have permission to access this page.';
                const tr = document.createElement("tr");
                const td = document.createElement("td");
                td.colSpan = 4; // Spanning all columns
                td.innerHTML = errorMsg;
                tr.appendChild(td);
                resultContainer.appendChild(tr);
                return;
            }
            // User is admin, proceed to display data
            for (const row of data) {
              // tr and td build out for each row
              const tr = document.createElement("tr");
              const name = document.createElement("td");
              const id = document.createElement("td");
              const age = document.createElement("td");
              const role = document.createElement("td");
              // data is specific to the API
              name.innerHTML = row.name; 
              id.innerHTML = row.uid; 
              age.innerHTML = row.age; 
              role.innerHTML = row.role
              // this builds td's into tr
              tr.appendChild(name);
              tr.appendChild(id);
              tr.appendChild(age);
              tr.appendChild(role);
              // append the row to table
              resultContainer.appendChild(tr);
            }
        })
    })
    </script>